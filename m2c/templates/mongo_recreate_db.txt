#!/bin/bash

# bash script to execute the mongoimport program to load the reference database.
# See https://github.com/cjoakim/mongodb-docker
#
# Generated on: {{ gen_timestamp }}
# Generated by: {{ gen_by }}
# Template:     mongo_recreate_db.txt

source env.sh

echo 'database URL: '$M2C_SOURCE_MONGODB_URL

echo 'init database ...'
mongo -u $M2C_SOURCE_MONGODB_USER -p $M2C_SOURCE_MONGODB_PASS $M2C_SOURCE_MONGODB_URL/admin < mongo/{{ dbname }}_init.ddl

{% for c in collections %}
echo 'mongoimport {{ c['name'] }} ...'
mongoimport --authenticationDatabase admin -u $M2C_SOURCE_MONGODB_USER -p $M2C_SOURCE_MONGODB_PASS --uri {{ uri }} \
    --db {{ dbname }} \
    --collection {{ c['name'] }} \
    --file {{ dbname }}/import_json/{{ c['infile'] }} \
    --numInsertionWorkers 1 \
    --batchSize 24 {{ ssl }}
{% endfor %}

echo 'done'
