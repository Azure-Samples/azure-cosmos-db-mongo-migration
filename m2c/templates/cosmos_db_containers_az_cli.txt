#!/bin/bash

# Bash shell script to create an autoscaled database, with containers
# in a CosmosDB/Mongo account.
#
# Database Name: {{ target_db }}
# Generated on:  {{ gen_timestamp }}
# Generated by:  {{ gen_by }}
# Template:      cosmos_db_containers_az_cli.txt

source env.sh

echo 'creating cosmos db: {{ target_db }}'
az cosmosdb mongodb database create \
    --resource-group $M2C_RG \
    --account-name $M2C_COSMOS_MONGODB_ACCT \
    --name {{ target_db }} \
    --max-throughput {{ ru }}

{% for c in collections -%}
echo 'creating cosmos collection: {{ c['name'] }}'
az cosmosdb mongodb collection create \
    --resource-group $M2C_RG \
    --account-name $M2C_COSMOS_MONGODB_ACCT \
    --database-name {{ target_db }} \
    --name {{ c['name'] }} \
    --shard {{ c['pk'] }}
    
    # --analytical-storage-ttl

# see https://docs.microsoft.com/en-us/cli/azure/cosmosdb/mongodb/collection?view=azure-cli-latest

{% endfor %}
echo 'done'
